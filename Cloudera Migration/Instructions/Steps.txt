Azure portal:
-------------
Create workshoprg resource group

Create snapshot for onprem disk

Command line:
-------------
Run PowerShell script to create Cloudera VM and resources

Copy 2000.zip + jar files to VM

On VM:
------
Restart cloudera-scm-agent

Restart cloudera-scm-server

Connect to Cloudera Manager using Web browser

Start all services

Restart any services that show an updated config

Unzip 2000.zip

kafka-topics --create --zookeeper onprem:2181 --replication-factor 1 --partitions 1 --topic flights

kafka-topics --list --zookeeper onprem:2181

java -cp EventProducer.jar eventdriver --bootstrap-servers onprem:9092 --sourcefilename 2000.csv --topic flights --partitions 1
(just run for 30 seconds)

java -cp Consumer.jar eventconsumer --bootstrap-servers onprem:9092 --topic flights --partition 0


Azure portal:
-------------
Create new resource group for HDInsight cluster

Create vnet (clustervnet) and subnet (clustersubnet) for HDInsight cluster

Peer clustervnet vnet with cloudervmvnet (workshoprg)

Create storage account named clusterstoragennn (Data Lake Gen-2 with hierarchical namespace) for HDInsight cluster

Create user assigned managed id (clusterid) and assign to storage account (Storage Blob Data Owner role)

Create HDInsight cluster:

  Name: kafkaclusternnn
  Type: Kafka
  Version: Kafka 2.1.1 (HDI 4.0)
  Credentials: admin/Pa55w.rdDemo
  Storage: Azure Data Lake Storage Gen2
  Storage account: clusterstoragennn
  User assigned managed identity: clusterid
  Virtual network: clustervnet and clustersubnet
  Enable encryption in transit
  Configuration: 3 x worker nodes
  
Connect to the cluster using Ambari to confirm it is running correctly

Use Hosts page to make a note of the address of the wn0-kafkac, wn1-kafkac, and wn2-kafkac nodes (Kafka broker nodes)

On ClouderaVM:
--------------

edit /etc/hosts and add IP addresses (10.x.x.x) of wnX-kafkac nodes

create source-cluster.properties file:

  bootstrap.servers=wn0-kafkac:9092,wn1-kafkac:9092,wn2-kafkac:9092

create dest-cluster.properties file:

  bootstrap.servers=onprem:9092
  group.id=mirror-group

java -cp EventProducer.jar eventdriver --bootstrap-servers onprem:9092 --sourcefilename 2000.csv --topic flights --partitions 1 >/tmp/data &
java -cp Consumer.jar eventconsumer --bootstrap-servers onprem:9092 --topic flights --partition 0 (just for a few seconds, to verify producer is running)

kafka-mirror-maker --producer.config source-cluster.properties --consumer.config dest-cluster.properties --whitelist flights &

On kafkacluster VM:
-------------------

edit /etc/hosts and add IP address for onprem VM (Cloudera)

/usr/hdp/4.1.1.2/kafka/bin/kafka-topics.sh --list --zookeeper onprem:2181 - verify that remote flights is visible

/usr/hdp/4.1.1.2/kafka/bin/kafka-topics.sh --create --zookeeper zk0-kafkac:2181 --replication-factor 3 --partitions 1 --topic flights

/usr/hdp/4.1.1.2/kafka/bin/kafka-topics.sh --list --zookeeper zk0-kafkac:2181 - verify that localflights is visible

/usr/hdp/4.1.1.2/kafka/bin/kafka-console-consumer.sh --bootstrap-server wn0-kafkac:2181 --topic flights

